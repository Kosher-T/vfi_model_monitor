# Phase 4: The Automation (The Manager)
name: Data Drift Monitor

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

# PERMISSION GRANT: Allow this job to trigger other workflows (The Red Phone)
permissions:
  actions: write
  contents: read

jobs:
  run_drift_check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Build QC Monitor Image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: vfi-monitor:latest
      
      - name: Run Drift Detection Container
        id: run_monitor
        run: |
          docker run \
            -v ${{ github.workspace }}/data/drifted_frames:/app/incoming_data \
            -v ${{ github.workspace }}/temp_status:/app/status_output \
            vfi-monitor:latest

      - name: Check Status and Trigger Retraining
        env:
          # Give the script access to the GitHub Token to make the call
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS=$(cat ${{ github.workspace }}/temp_status/status.txt)
          echo "QC Verdict: $STATUS"

          if [[ "$STATUS" == "FAIL" ]]; then
            echo "::error::ðŸš¨ High Drift Detected! Triggering Model Retraining..."
            
            # --- THE RED PHONE ---
            # Use GitHub CLI to trigger the retraining pipeline
            gh workflow run retraining_pipeline.yml -f drift_score="89.38"
            
            echo "âœ… Retraining Triggered. Marking this monitor run as Failed to alert humans."
            exit 1 
          else
            echo "âœ… Data is good. Factory running smoothly."
          fi