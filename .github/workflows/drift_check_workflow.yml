# Phase 4: The Automation (The Manager)
name: Data Drift Monitor

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  run_drift_check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Build QC Monitor Image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: vfi-monitor:latest
      
      - name: Run Drift Detection Container
        id: run_monitor
        # NEW: We inject configuration using environment variables (-e)
        run: |
          docker run \
            -e DRIFT_THRESHOLD=30.0 \
            -e P_VALUE_THRESHOLD=0.05 \
            -v ${{ github.workspace }}/data/drifted_frames:/app/incoming_data \
            -v ${{ github.workspace }}/temp_status:/app/status_output \
            vfi-monitor:latest

      - name: Check Status and Trigger Retraining
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS=$(cat ${{ github.workspace }}/temp_status/status.txt)
          SCORE=$(cat ${{ github.workspace }}/temp_status/score.txt)
          
          echo "QC Verdict: $STATUS"
          echo "Detected Drift Score: $SCORE%"

          if [[ "$STATUS" == "FAIL" ]]; then
            echo "::error::ðŸš¨ High Drift Detected! Calling the Repair Crew..."
            gh workflow run retraining_pipeline.yml -f drift_score="$SCORE"
            echo "âœ… Retraining Triggered."
            exit 1 
          else
            echo "âœ… Data is good. Factory running smoothly."
          fi